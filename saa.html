<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://ssl.p.jwpcdn.com/player/v/8.32.0/jwplayer.js"></script>
  <!-- Load hls.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    jwplayer.key = 'cLGMn8T20tGvW+0eXPhq4NNmLB57TrscPjd1IyJF84o=';
  </script>
  <style>
    html,body { height:100%; margin:0; background:#000; }
    #player { width:100%; height:100%; background:#000; position:relative; }

    /* Password overlay */
    #pwOverlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6));
      backdrop-filter: blur(4px);
    }
    #pwBox {
      width: 92%;
      max-width: 420px;
      background: rgba(18,18,18,0.95);
      border-radius: 10px;
      padding: 18px;
      text-align: center;
      box-shadow: 0 6px 24px rgba(0,0,0,0.6);
      color: #eee;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    #pwBox h3 { margin: 0 0 10px; color: #ff6347; font-size:18px; }
    #pwInput {
      width: calc(100% - 110px);
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #0d0d0d;
      color: #eee;
      font-size: 15px;
      outline: none;
    }
    #pwBtn {
      padding: 10px 12px;
      margin-left: 8px;
      border-radius: 8px;
      border: none;
      background: #1e90ff;
      color: #fff;
      cursor: pointer;
      font-size: 15px;
    }
    #pwMsg { margin-top:10px; color:#d0d0d0; font-size:13px; min-height:18px; }

    /* Small overlay message (keeps existing overlay usage) */
    #overlayMsg {
      position: absolute;
      left: 8px;
      top: 8px;
      z-index: 9998;
      color: #fff;
      background: rgba(0,0,0,.5);
      padding: 6px 10px;
      border-radius: 6px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      font-size: 13px;
      display:none;
    }

    /* Keep original JW style tweaks */
    .jw-title-primary { font-weight: bold; font-size: 1.5em; color: #ff6347 !important; }
    .jwplayer .jw-progress { background-color:  #06b6d4 !important; }
    .jwplayer .jw-text-time { color: #ff6347 !important; }
    .jwplayer .jw-button:hover { background: #ff6347 !important; }
    .jw-rightclick .jw-reset { display: none; }
  </style>
</head>
<body>
  <div id="player"></div>

  <div id="overlayMsg"></div>

  <!-- Inline password overlay -->
  <div id="pwOverlay" aria-hidden="false">
    <div id="pwBox" role="dialog" aria-labelledby="pwTitle" aria-describedby="pwHelp">
      <h3 id="pwTitle">Enter Password to Unlock Stream</h3>
      <div style="display:flex; align-items:center; justify-content:center;">
        <input id="pwInput" type="password" autocomplete="current-password" aria-label="Password" placeholder="Password" />
        <button id="pwBtn" aria-label="Unlock">Unlock</button>
      </div>
      <div id="pwMsg" role="status" aria-live="polite">Enter the password to start playback.</div>
      <div style="margin-top:10px; font-size:12px; color:#888">This uses client-side decryption (not full security).</div>
    </div>
  </div>

  <script>
  (async function () {
    // ---------------- ENCRYPTED PAYLOAD (generated for the URL https://pothabattulavinod.github.io/pay/hi.m3u8 with password "123") ----------------
    // Format: PBKDF2 (sha256) -> AES-GCM
    const ENCRYPTED = {
      kdf: "pbkdf2",
      kdf_hash: "sha256",
      iterations: 200000,
      salt_b64: "4KY1iui+zdQspq+llZ3oiw==",
      iv_b64: "B1C9ob0HGs4/P/tL",
      ct_b64: "wA/rTdrCxlreVkiwAqz3qEy/36AV3iomAoKWuO5jjkywh2jiH1/rf6BU/1uVvIXO9i3q6yPNYBqummJkhhez"
    };
    // -------------------------------------------------------------------------------------------------------------------------------

    const overlay = document.getElementById('overlayMsg');
    function showOverlay(msg, timeout) {
      overlay.textContent = msg;
      overlay.style.display = 'block';
      if (timeout) setTimeout(()=> overlay.style.display='none', timeout);
    }

    // Helper: base64 -> ArrayBuffer
    function b64ToBuf(b64) {
      const bin = atob(b64);
      const len = bin.length;
      const buf = new Uint8Array(len);
      for (let i = 0; i < len; i++) buf[i] = bin.charCodeAt(i);
      return buf.buffer;
    }

    async function deriveKey(password, salt_b64, iterations) {
      const enc = new TextEncoder();
      const pwKey = await crypto.subtle.importKey(
        "raw",
        enc.encode(password),
        { name: "PBKDF2" },
        false,
        ["deriveKey"]
      );
      const saltBuf = b64ToBuf(salt_b64);
      const derivedKey = await crypto.subtle.deriveKey(
        {
          "name": "PBKDF2",
          salt: saltBuf,
          iterations: iterations,
          hash: "SHA-256"
        },
        pwKey,
        { name: "AES-GCM", length: 256 },
        false,
        ["decrypt"]
      );
      return derivedKey;
    }

    async function decryptPayload(password) {
      const p = ENCRYPTED;
      if (p.kdf !== "pbkdf2") throw new Error("Unsupported KDF");
      const key = await deriveKey(password, p.salt_b64, p.iterations);
      const iv = b64ToBuf(p.iv_b64);
      const ciphertext = b64ToBuf(p.ct_b64);
      const plainBuf = await crypto.subtle.decrypt(
        { name: "AES-GCM", iv: iv },
        key,
        ciphertext
      );
      const dec = new TextDecoder();
      return dec.decode(plainBuf);
    }

    // UI elements
    const pwOverlay = document.getElementById('pwOverlay');
    const pwInput = document.getElementById('pwInput');
    const pwBtn = document.getElementById('pwBtn');
    const pwMsg = document.getElementById('pwMsg');

    // Unlock handler
    async function attemptUnlock() {
      const pwd = pwInput.value || '';
      if (!pwd) {
        pwMsg.textContent = 'Please enter a password.';
        return;
      }
      pwMsg.textContent = 'Decrypting...';
      try {
        const decrypted = await decryptPayload(pwd);
        // success: hide overlay and initialize player with decrypted URL/content
        pwOverlay.style.display = 'none';
        initPlayerWithDecrypted(decrypted);
        showOverlay('Decryption successful — initializing player...', 3000);
      } catch (e) {
        console.warn('Decrypt failed', e);
        pwMsg.textContent = 'Incorrect password or decryption failed.';
        // small shake animation (optional)
        pwBoxAnimate();
      }
    }

    // Small animation to indicate failure
    function pwBoxAnimate() {
      const box = document.getElementById('pwBox');
      box.style.transition = 'transform 0.08s';
      box.style.transform = 'translateX(-6px)';
      setTimeout(()=> { box.style.transform = 'translateX(6px)'; }, 80);
      setTimeout(()=> { box.style.transform = 'translateX(0px)'; }, 160);
    }

    pwBtn.addEventListener('click', attemptUnlock);
    pwInput.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter') attemptUnlock();
    });

    // Decrypt result -> initialize JWPlayer
    async function initPlayerWithDecrypted(decrypted) {
      // decrypted expected to be a URL like "https://.../hi.m3u8" or the full m3u8 content
      let sourceUrl = null;
      if (decrypted.trim().startsWith("http://") || decrypted.trim().startsWith("https://")) {
        sourceUrl = decrypted.trim();
      } else {
        const blob = new Blob([decrypted], { type: "application/vnd.apple.mpegurl" });
        sourceUrl = URL.createObjectURL(blob);
      }

      // Setup JWPlayer using the decrypted source (preserve all your config)
      var jwp = jwplayer('player');
      var pageUrl = window.location.href;
      var playbackKey = `jwplayer-playback-position-${pageUrl}`;

      // Load saved position from localStorage (we'll seek on 'ready')
      var savedPosition = localStorage.getItem(playbackKey);

      jwp.setup({
        aspectratio: "16:9",
        width: "100%",
        height: "100%",
        sources: [{
          file: sourceUrl,
          type: "hls",
          default: true
        }],
        image: "",
        primary: "html5",
        preload: "auto",
        title: "",
        bufferLength: 5,
        hlshtml: true,
        html5: {
          hlsjsConfig: {
            liveSyncDuration: 3,
            maxBufferLength: 30
          }
        },
        abr: { enabled: true },
        cast: { enabled: true },
        controls: true,
        displayPlaybackLabel: false,
        liveTimeout: 2,
        dvrSeekLimit: 60,
        dvrWindow: 3600,
        logo: {
          file: "",
          position: "top-right",
          margin: 10,
          link: "",
          hide: false,
          width: 100,
          height: 50
        },
        tracks: [{
          file: "https://raw.githubusercontent.com/pothabattulavinod/wp/refs/heads/main/hinanna.vtt",
          label: "English",
          kind: "captions",
          "default": true,
          language: "en"
        }]
      });

      jwp.on('ready', function () {
        // Seek to the saved position if available
        if (savedPosition && !isNaN(savedPosition)) {
          jwp.seek(parseFloat(savedPosition));
        }

        // Attempt to add forward button(s) — best-effort (JW internals may vary)
        try {
          const playerContainer = document.querySelector('#player');

          const rewindContainer = playerContainer.querySelector('.jw-display-icon-rewind');
          if (rewindContainer) {
            const forwardContainer = rewindContainer.cloneNode(true);
            const forwardDisplayButton = forwardContainer.querySelector('.jw-icon-rewind');
            forwardDisplayButton.style.transform = "scaleX(-1)";
            forwardDisplayButton.ariaLabel = "Forward 10 Seconds";
            const nextContainer = playerContainer.querySelector('.jw-display-icon-next');
            if (nextContainer && nextContainer.parentNode) {
              nextContainer.parentNode.insertBefore(forwardContainer, nextContainer);
            }
          }

          const buttonContainer = playerContainer.querySelector('.jw-button-container');
          if (buttonContainer) {
            const rewindControlBarButton = buttonContainer.querySelector(".jw-icon-rewind");
            if (rewindControlBarButton) {
              const forwardControlBarButton = rewindControlBarButton.cloneNode(true);
              forwardControlBarButton.style.transform = "scaleX(-1)";
              forwardControlBarButton.ariaLabel = "Forward 10 Seconds";
              rewindControlBarButton.parentNode.insertBefore(forwardControlBarButton, rewindControlBarButton.nextElementSibling);

              // Add onclick handler
              forwardControlBarButton.onclick = () => {
                jwp.seek(jwp.getPosition() + 10);
              };
            }
            const displayNext = playerContainer.querySelector('.jw-display-icon-next');
            if (displayNext) displayNext.style.display = 'none';
          }
        } catch (e) {
          console.warn("Could not customize icons (DOM may vary):", e);
        }
      });

      // Save playback position
      jwp.on('time', function (event) {
        localStorage.setItem(playbackKey, event.position);
      });

      // Clear position when complete
      jwp.on('complete', function () {
        localStorage.removeItem(playbackKey);
      });

      // diagnostics
      if (typeof Hls !== "undefined") {
        if (Hls.isSupported()) {
          console.log("✅ hls.js is supported and running.");
        } else {
          console.log("ℹ️ Falling back to native HLS (Safari / iPhone).");
        }
      } else {
        console.log("⚠️ hls.js not loaded, relying on JWPlayer native handling.");
      }
    }

    // Focus password input on load
    pwInput.focus();

  })();
  </script>
</body>
</html>
