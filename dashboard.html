<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>WILD ROCKER â€” Secure Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
:root{--bg:#020204;--neon:#39ff14;--muted:#7f8f7f;--panel:rgba(0,0,0,0.55);}
body{background:var(--bg);color:var(--neon);font-family:"Courier New",monospace;min-height:100vh;display:flex;flex-direction:column;}
.navbar{background:rgba(0,0,0,0.6);border-bottom:1px solid rgba(57,255,20,0.2);}
.navbar-brand{color:var(--neon)!important;font-weight:700;}
.logout-btn{border:1px solid rgba(57,255,20,0.3);color:var(--neon);background:transparent;border-radius:8px;padding:8px 18px;}
.dashboard{flex:1;padding:40px 20px;display:flex;flex-direction:column;align-items:center;}
.status-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;width:100%;max-width:1100px;margin-top:30px;}
.status-card{background:var(--panel);border-radius:12px;padding:20px;}
.chat-panel{margin-top:40px;background:var(--panel);border-radius:12px;padding:20px;max-width:700px;width:100%;}
.chat-messages{background:rgba(0,0,0,0.4);border-radius:8px;padding:10px;height:300px;overflow-y:auto;display:flex;flex-direction:column;}
.msg{max-width:70%;padding:8px 12px;margin:5px 0;border-radius:8px;word-wrap:break-word;}
.msg small{display:block;color:var(--muted);font-size:0.7rem;margin-top:4px;}
.sent{align-self:flex-end;background:rgba(57,255,20,0.1);}
.recv{align-self:flex-start;background:rgba(255,255,255,0.05);}
.chat-input{display:flex;gap:10px;}
.chat-input textarea{flex:1;background:transparent;border:1px dashed rgba(57,255,20,0.2);color:var(--neon);border-radius:8px;padding:6px 10px;height:60px;}
.chat-input button{background:transparent;border:1px solid rgba(57,255,20,0.3);color:var(--neon);border-radius:8px;padding:0 16px;}
</style>
</head>
<body>
<nav class="navbar navbar-dark"><div class="container-fluid"><span class="navbar-brand">âš¡ WILD ROCKER DASHBOARD</span><button id="logoutBtn" class="logout-btn">Logout</button></div></nav>
<div class="dashboard">
  <h1 id="welcomeText">Welcome, Operator</h1>
  <p id="roleText">Access Level: --</p>
  <div class="chat-panel">
    <h4>ðŸ’¬ Secure Chat</h4>
    <select id="recipient" class="form-select mb-2" style="background:transparent;color:var(--neon);">
      <option>Loading users...</option>
    </select>
    <div class="chat-messages" id="chatBox">Loading chat...</div>
    <div class="chat-input">
      <textarea id="chatMsg" placeholder="Type your message..."></textarea>
      <button id="sendMsgBtn">Send</button>
    </div>
  </div>
</div>
<footer class="text-center text-muted py-2">Â© 2025 WILD ROCKER Systems</footer>

<script>
const SHEET_ENDPOINT="https://script.google.com/macros/s/AKfycbzUoPSgUurTq3iWva4Gdf7NIcxlCqPw5DrhSLmlvjZBlqw7CnE6EHtrQ679k9H5Bkr5vA/exec";
const user=sessionStorage.getItem("user");
if(!user)location.href="index.html";
let currentRecipient="";
let userName=user;

// logout
document.getElementById("logoutBtn").onclick=()=>{sessionStorage.clear();location.href="index.html";};

// load users
async function fetchUsers(){
  const res=await fetch(SHEET_ENDPOINT+"?sheet=Sheet1");
  const data=await res.json();
  const sel=document.getElementById("recipient");
  sel.innerHTML="<option value=''>Select recipient</option>";
  data.forEach(u=>{
    if(u.Username!==user){
      const o=document.createElement("option");
      o.value=u.Username;o.textContent=u.Name||u.Username;
      sel.appendChild(o);
    }else{userName=u.Name||user;}
  });
  document.getElementById("welcomeText").textContent=`Welcome, ${userName}`;
}
fetchUsers();

// load chat messages
async function loadChat(){
  const r=currentRecipient;
  if(!r)return;
  const res=await fetch(SHEET_ENDPOINT+"?sheet=Chat&t="+Date.now());
  const msgs=await res.json();
  const chatBox=document.getElementById("chatBox");
  chatBox.innerHTML="";
  msgs.filter(m=>(m.Sender===user&&m.Recipient===r)||(m.Sender===r&&m.Recipient===user))
  .forEach(m=>{
    const d=document.createElement("div");
    d.className="msg "+(m.Sender===user?"sent":"recv");
    let seen=(m.SeenBy&&m.SeenBy.includes(r))?"<small>âœ” Seen</small>":"";
    d.innerHTML=`${m.Message}<small>${new Date(m.Timestamp).toLocaleTimeString()}</small>${m.Sender===user?seen:""}`;
    chatBox.appendChild(d);
  });
  chatBox.scrollTop=chatBox.scrollHeight;

  // mark as seen
  await fetch(SHEET_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"seen",viewer:user,with:r})});
}

// select recipient
document.getElementById("recipient").onchange=()=>{currentRecipient=document.getElementById("recipient").value;loadChat();};

// send message
async function sendChat(){
  const msg=document.getElementById("chatMsg").value.trim();
  if(!msg||!currentRecipient)return;
  const payload={sender:user,recipient:currentRecipient,message:msg};
  await fetch(SHEET_ENDPOINT,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  document.getElementById("chatMsg").value="";
  setTimeout(loadChat,800);
}
document.getElementById("sendMsgBtn").onclick=sendChat;
setInterval(()=>{if(currentRecipient)loadChat();},4000);
</script>
</body>
</html>
