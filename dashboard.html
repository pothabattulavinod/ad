<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>WILD ROCKER â€” Secure Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root{
  --bg:#020204;
  --neon:#39ff14;
  --muted:#7f8f7f;
  --panel:rgba(0,0,0,0.55);
}
body{
  background:var(--bg);
  color:var(--neon);
  font-family:"Courier New", monospace;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
.navbar{
  background:rgba(0,0,0,0.6);
  border-bottom:1px solid rgba(57,255,20,0.2);
}
.navbar-brand{
  color:var(--neon)!important;
  font-weight:700;
}
.logout-btn{
  border:1px solid rgba(57,255,20,0.3);
  color:var(--neon);
  background:transparent;
  border-radius:8px;
  padding:8px 18px;
}
.logout-btn:hover{
  background:rgba(57,255,20,0.15);
}
.dashboard{
  flex:1;
  padding:40px 20px;
  display:flex;
  flex-direction:column;
  align-items:center;
}
h1{font-size:1.8rem;text-shadow:0 0 10px rgba(57,255,20,0.4);}
#roleText{color:var(--muted);font-size:0.9rem;margin-bottom:20px;}
.status-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:20px;
  width:100%;
  max-width:1100px;
  margin-top:10px;
}
.status-card{
  background:var(--panel);
  border-radius:12px;
  padding:20px;
  border:1px solid rgba(57,255,20,0.1);
  text-align:center;
}
.status-title{color:var(--muted);font-size:0.9rem;font-weight:bold;}
.status-value{font-size:1.3rem;margin-top:6px;color:var(--neon);}

/* Chat Section */
.chat-panel{
  margin-top:40px;
  background:var(--panel);
  border:1px solid rgba(57,255,20,0.1);
  border-radius:12px;
  padding:20px;
  max-width:700px;
  width:100%;
}
.chat-messages{
  background:rgba(0,0,0,0.4);
  border:1px solid rgba(57,255,20,0.1);
  border-radius:8px;
  padding:10px;
  height:350px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
}
.msg{
  max-width:70%;
  padding:8px 12px;
  margin:4px 0;
  border-radius:8px;
  word-wrap:break-word;
  font-size:0.9rem;
}
.sent{
  align-self:flex-end;
  background:rgba(57,255,20,0.1);
}
.recv{
  align-self:flex-start;
  background:rgba(255,255,255,0.05);
}
.msg small{
  display:block;
  color:var(--muted);
  font-size:0.7rem;
  margin-top:4px;
}
.chat-input{
  display:flex;
  gap:10px;
  margin-top:8px;
}
.chat-input textarea{
  flex:1;
  background:transparent;
  border:1px dashed rgba(57,255,20,0.2);
  color:var(--neon);
  border-radius:8px;
  padding:6px 10px;
  height:60px;
  resize:none;
}
.chat-input button{
  background:transparent;
  border:1px solid rgba(57,255,20,0.3);
  color:var(--neon);
  border-radius:8px;
  padding:0 16px;
}
.chat-input button:hover{
  background:rgba(57,255,20,0.15);
}
footer{
  text-align:center;
  color:var(--muted);
  font-size:0.85rem;
  padding:10px 0;
}
</style>
</head>

<body>
<nav class="navbar navbar-dark">
  <div class="container-fluid">
    <span class="navbar-brand">âš¡ WILD ROCKER DASHBOARD</span>
    <button id="logoutBtn" class="logout-btn">Logout</button>
  </div>
</nav>

<div class="dashboard">
  <h1 id="welcomeText">Welcome, Operator</h1>
  <p id="roleText">Access Level: --</p>

  <!-- Chat -->
  <div class="chat-panel">
    <h4>ðŸ’¬ Secure Chat</h4>
    <select id="recipient" class="form-select mb-2" style="background:transparent;color:var(--neon);border:1px dashed rgba(57,255,20,0.2);">
      <option>Loading users...</option>
    </select>
    <div class="chat-messages" id="chatBox">Loading chat...</div>
    <div class="chat-input">
      <textarea id="chatMsg" placeholder="Type your message..."></textarea>
      <button id="sendMsgBtn">Send</button>
    </div>
  </div>
</div>

<footer>Â© 2025 WILD ROCKER Systems</footer>

<script>
const SHEET_ENDPOINT = "https://script.google.com/macros/s/AKfycbwRqGmyV2yoyEOxG0tfrCRidmqmCI_Iu5YV371JChC-SM7QV2C7l4Xt1R_ZbqWYMT0leA/exec";
const user = sessionStorage.getItem("user");
if(!user){ location.href="index.html"; }

let currentRecipient = "";
let userName = user;

// Logout
document.getElementById("logoutBtn").onclick = () => {
  sessionStorage.clear();
  location.href = "index.html";
};

// Load users
async function fetchUsers(){
  try {
    const res = await fetch(SHEET_ENDPOINT + "?sheet=Sheet1");
    const data = await res.json();
    const sel = document.getElementById("recipient");
    sel.innerHTML = "<option value=''>Select recipient</option>";

    data.forEach(u => {
      if(u.Username !== user){
        const opt = document.createElement("option");
        opt.value = u.Username;
        opt.textContent = u.Name || u.Username;
        sel.appendChild(opt);
      } else {
        userName = u.Name || user;
        document.getElementById("welcomeText").textContent = `Welcome, ${userName}`;
        document.getElementById("roleText").textContent = `Access Level: ${u.Role || "User"}`;
      }
    });
  } catch (e) {
    console.error("User fetch failed", e);
  }
}
fetchUsers();

// Load chat for selected user
async function loadChat(){
  if(!currentRecipient) return;
  try {
    const res = await fetch(SHEET_ENDPOINT + "?sheet=Chat&t=" + Date.now());
    const msgs = await res.json();
    const chatBox = document.getElementById("chatBox");
    chatBox.innerHTML = "";

    msgs
      .filter(m =>
        (m.Sender === user && m.Recipient === currentRecipient) ||
        (m.Sender === currentRecipient && m.Recipient === user)
      )
      .forEach(m => {
        const div = document.createElement("div");
        div.className = "msg " + (m.Sender === user ? "sent" : "recv");
        const seen = (m.Sender === user && m.SeenBy && m.SeenBy.includes(currentRecipient))
          ? "<small>âœ” Seen</small>" : "";
        div.innerHTML = `${m.Message}<small>${new Date(m.Timestamp).toLocaleTimeString()}</small>${seen}`;
        chatBox.appendChild(div);
      });

    chatBox.scrollTop = chatBox.scrollHeight;

    // Mark as seen
    await fetch(SHEET_ENDPOINT, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ action: "seen", viewer: user, with: currentRecipient })
    });
  } catch(e){
    console.error("Chat load failed", e);
  }
}

// Select recipient
document.getElementById("recipient").onchange = () => {
  currentRecipient = document.getElementById("recipient").value;
  loadChat();
};

// Send message
async function sendChat(){
  const msg = document.getElementById("chatMsg").value.trim();
  if(!msg || !currentRecipient) return;

  const payload = { sender: user, recipient: currentRecipient, message: msg };
  try {
    await fetch(SHEET_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    document.getElementById("chatMsg").value = "";
    setTimeout(loadChat, 500);
  } catch(e){
    console.error("Send failed", e);
  }
}
document.getElementById("sendMsgBtn").onclick = sendChat;

// Refresh chat periodically
setInterval(() => { if(currentRecipient) loadChat(); }, 4000);
</script>
</body>
</html>
